<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Multi-fragment&nbsp;Registration&nbsp;Library: MultiFragmentFeatureRegistration.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Multi-fragment&nbsp;Registration&nbsp;Library
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Library for multi-fragment atlas-based 2D-3D reconstruction</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MultiFragmentFeatureRegistration.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>The bone is reconstructed from one proximal and one distal fragment. The vertex metric ensures the length of the reconstructed bone is estimated accurately. The images from the registration are saved to the "examples3_images" folder, the reconstructed and reduced polygonal model is stored as "example3.stl". For more details, please see previous examples.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;QApplication&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;QDebug&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;QTextStream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;QFile&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define _USE_MATH_DEFINES</span></div><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;ssimrenderer.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="libmultifragmentregister_8h.html">libmultifragmentregister.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tsimplemetric_8h.html">ImageMetric/tsimplemetric.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tsimplevertexmetric_8h.html">VertexMetric/tsimplevertexmetric.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="tdefaultobserver_8h.html">Observer/TDefaultObserver.h</a>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">    QApplication a(argc, argv);</div><div class="line">    a.addLibraryPath(<span class="stringliteral">&quot;plugins&quot;</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">typedef</span> <a name="_a0"></a><a class="code" href="class_lib_multi_fragment_register.html">LibMultiFragmentRegister&lt;TSimpleMetric&gt;</a> RegistrationType;</div><div class="line">    RegistrationType * registration = RegistrationType::New(2, 2, <span class="keyword">new</span> <a name="_a1"></a><a class="code" href="class_t_simple_vertex_metric.html">TSimpleVertexMetric</a>);</div><div class="line"></div><div class="line"></div><div class="line">    QString         meshFileName = DATA_PATH <span class="stringliteral">&quot;/mean.230.a10.mesh&quot;</span>;</div><div class="line">    QString      densityFileName = DATA_PATH <span class="stringliteral">&quot;/density.b2.mat&quot;</span>;</div><div class="line">    QString       saveImagesPath = DATA_PATH <span class="stringliteral">&quot;/example3_images&quot;</span>;</div><div class="line"></div><div class="line">    QString       image1FileName = DATA_PATH <span class="stringliteral">&quot;/226.7.proximal.png&quot;</span>;</div><div class="line">    QString       image2FileName = DATA_PATH <span class="stringliteral">&quot;/226.10.proximal.png&quot;</span>;</div><div class="line">    QString       image3FileName = DATA_PATH <span class="stringliteral">&quot;/226.7.distal.png&quot;</span>;</div><div class="line">    QString       image4FileName = DATA_PATH <span class="stringliteral">&quot;/226.10.distal.png&quot;</span>;</div><div class="line"></div><div class="line">    QString perspective1FileName = DATA_PATH <span class="stringliteral">&quot;/226.7.png.csv&quot;</span>;</div><div class="line">    QString perspective2FileName = DATA_PATH <span class="stringliteral">&quot;/226.10.png.csv&quot;</span>;</div><div class="line"></div><div class="line">    QString        pose1FileName = DATA_PATH <span class="stringliteral">&quot;/transform.226.csv6.csv&quot;</span>;</div><div class="line">    QString        pose2FileName = DATA_PATH <span class="stringliteral">&quot;/transform.226.csv7.csv&quot;</span>;</div><div class="line">    QString        shapeFileName = DATA_PATH <span class="stringliteral">&quot;/shape.mat&quot;</span>;</div><div class="line"></div><div class="line">    QString   polygonalModelName = DATA_PATH <span class="stringliteral">&quot;/example3&quot;</span>;</div><div class="line"></div><div class="line">    SSIMRenderer::Lm6MeshFile * meshFile;</div><div class="line">    SSIMRenderer::MatStatisticalDataFile * shapeFile;</div><div class="line">    SSIMRenderer::MatStatisticalDataFile * densityFile;</div><div class="line">    QVector&lt;float&gt; pose1File;</div><div class="line">    QVector&lt;float&gt; pose2File;</div><div class="line">    QVector&lt;float&gt; perspective1File;</div><div class="line">    QVector&lt;float&gt; perspective2File;</div><div class="line"></div><div class="line">    <span class="keywordflow">try</span> {</div><div class="line">        meshFile         = <span class="keyword">new</span> SSIMRenderer::Lm6MeshFile(meshFileName);</div><div class="line">        shapeFile        = <span class="keyword">new</span> SSIMRenderer::MatStatisticalDataFile(shapeFileName);</div><div class="line">        densityFile      = <span class="keyword">new</span> SSIMRenderer::MatStatisticalDataFile(densityFileName);</div><div class="line">        pose1File        = RegistrationType::loadDataFromCSVFile(pose1FileName);</div><div class="line">        pose2File        = RegistrationType::loadDataFromCSVFile(pose2FileName);</div><div class="line">        perspective1File = RegistrationType::loadDataFromCSVFile(perspective1FileName);</div><div class="line">        perspective2File = RegistrationType::loadDataFromCSVFile(perspective2FileName);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">catch</span> (std::exception &amp;e) {</div><div class="line">        <span class="comment">// Wrong file</span></div><div class="line">        qFatal(e.what());</div><div class="line">        exit(EXIT_FAILURE);</div><div class="line">    }</div><div class="line"></div><div class="line">    registration-&gt;enableDensity(<span class="keyword">false</span>);</div><div class="line">    registration-&gt;setMeshModel(meshFile);</div><div class="line">    registration-&gt;setDensityModel(densityFile);</div><div class="line">    registration-&gt;setShapeModel(shapeFile);</div><div class="line"></div><div class="line">    QVector&lt;QSize&gt; sizes(4);</div><div class="line">    sizes[0] = QImage(image1FileName).scaledToHeight(512).size();</div><div class="line">    sizes[1] = QImage(image2FileName).scaledToHeight(512).size();</div><div class="line">    sizes[2] = QImage(image3FileName).scaledToHeight(512).size();</div><div class="line">    sizes[3] = QImage(image4FileName).scaledToHeight(512).size();</div><div class="line"></div><div class="line">    registration-&gt;setSizes(sizes);</div><div class="line">    QVector&lt;QRect&gt; crops(4);</div><div class="line">    crops[0] = QRect(QPoint(0, 256), QPoint(511, 511));</div><div class="line">    crops[1] = QRect(QPoint(0, 256), QPoint(511, 511));</div><div class="line">    crops[2] = QRect(QPoint(0, 0), QPoint(511, 255));</div><div class="line">    crops[3] = QRect(QPoint(0, 0), QPoint(511, 255));</div><div class="line">    registration-&gt;setCrops(crops);</div><div class="line"></div><div class="line">    QVector&lt;QRectF&gt; openGlCrops(4);</div><div class="line">    openGlCrops[0] = QRectF(-1, 0, 2, 1);</div><div class="line">    openGlCrops[1] = QRectF(-1, 0, 2, 1);</div><div class="line">    openGlCrops[2] = QRectF(-1, -1, 2, 1);</div><div class="line">    openGlCrops[3] = QRectF(-1, -1, 2, 1);</div><div class="line">    registration-&gt;setOpenGLCrops(openGlCrops);</div><div class="line"></div><div class="line">    registration-&gt;enableMirroring(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    QVector&lt;QVector3D&gt; rotations(2);</div><div class="line">    rotations[0] = QVector3D(pose1File[0], pose1File[1], pose1File[2]);</div><div class="line">    rotations[1] = QVector3D(pose2File[0], pose2File[1], pose2File[2]);</div><div class="line">    QVector&lt;QVector3D&gt; translations(2);</div><div class="line">    translations[0] = QVector3D(pose1File[3], pose1File[4], pose1File[5]);</div><div class="line">    translations[1] = QVector3D(pose2File[3], pose2File[4], pose2File[5]);</div><div class="line"></div><div class="line">    registration-&gt;setRotations(rotations);</div><div class="line">    registration-&gt;setTranslations(translations);</div><div class="line"></div><div class="line">    SSIMRenderer::Pyramid perspective1(</div><div class="line">            QVector3D(perspective1File[0],  perspective1File[4],  perspective1File[2]),</div><div class="line">            QVector3D(perspective1File[3],  perspective1File[1],  perspective1File[5]),</div><div class="line">            QVector3D(perspective1File[6],  perspective1File[10], perspective1File[8]),</div><div class="line">            QVector3D(perspective1File[9],  perspective1File[7],  perspective1File[11]),</div><div class="line">            QVector3D(perspective1File[15], perspective1File[16], perspective1File[17])</div><div class="line">        );</div><div class="line"></div><div class="line">    SSIMRenderer::Pyramid perspective2(</div><div class="line">            QVector3D(perspective2File[0],  perspective2File[4],  perspective2File[2]),</div><div class="line">            QVector3D(perspective2File[3],  perspective2File[1],  perspective2File[5]),</div><div class="line">            QVector3D(perspective2File[6],  perspective2File[10], perspective2File[8]),</div><div class="line">            QVector3D(perspective2File[9],  perspective2File[7],  perspective2File[11]),</div><div class="line">            QVector3D(perspective2File[15], perspective2File[16], perspective2File[17])</div><div class="line">        );</div><div class="line"></div><div class="line">    QVector&lt;SSIMRenderer::Pyramid&gt; perspectives(4);</div><div class="line">    perspectives[0] = perspective1;</div><div class="line">    perspectives[1] = perspective2;</div><div class="line">    perspectives[2] = perspective1;</div><div class="line">    perspectives[3] = perspective2;</div><div class="line"></div><div class="line">    registration-&gt;setPerspectives(perspectives);</div><div class="line"></div><div class="line">    QVector&lt;QImage&gt; images(4);</div><div class="line">    images[0] = RegistrationType::maskImage(QImage(image1FileName).scaledToHeight(512).copy(crops.at(0)));</div><div class="line">    images[1] = RegistrationType::maskImage(QImage(image2FileName).scaledToHeight(512).copy(crops.at(1)));</div><div class="line">    images[2] = RegistrationType::maskImage(QImage(image3FileName).scaledToHeight(512).copy(crops.at(2)));</div><div class="line">    images[3] = RegistrationType::maskImage(QImage(image4FileName).scaledToHeight(512).copy(crops.at(3)));</div><div class="line"></div><div class="line">    registration-&gt;setImages(images);</div><div class="line">    registration-&gt;setCrops(crops);</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> pn = registration-&gt;getShapeParams().size();</div><div class="line">    registration-&gt;setShapeParams(QVector&lt;float&gt;(pn, 0));</div><div class="line"></div><div class="line">    <a name="_a2"></a><a class="code" href="class_t_default_observer.html">TDefaultObserver</a> * observer = <span class="keyword">new</span> <a class="code" href="class_t_default_observer.html">TDefaultObserver</a>;</div><div class="line">    observer-&gt;<a name="a3"></a>setVerbose(<span class="keyword">true</span>);</div><div class="line">    observer-&gt;<a name="a4"></a>enableImages(<span class="keyword">true</span>);</div><div class="line">    observer-&gt;<a name="a5"></a>setImagesPath(saveImagesPath);</div><div class="line">    observer-&gt;<a name="a6"></a>setRefImages(images);</div><div class="line">    observer-&gt;<a name="a7"></a>setWholeBones(<span class="keyword">true</span>);</div><div class="line">    registration-&gt;setObserver(observer);</div><div class="line"></div><div class="line">    registration-&gt;optimizePose();</div><div class="line">    registration-&gt;optimizePoseShapeVertex(5);</div><div class="line">    registration-&gt;optimizePoseShapeVertex();</div><div class="line"></div><div class="line">    registration-&gt;exportSTL(polygonalModelName);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Jul 12 2017 16:41:28 for Multi-fragment&nbsp;Registration&nbsp;Library by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.12
</small></address>
</body>
</html>
